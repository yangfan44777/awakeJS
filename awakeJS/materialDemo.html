<html>
	
	
	<script src="core\Renderer.js" ></script>
	
	<script src="core\Material.js" ></script>
	<script src="math\Matrix4.js"></script>
	<script src="math\Matrix3.js"></script>
	<script src="math\Vector3.js"></script>
	
<script src="core\Face.js" ></script>
<script src="core\Camera.js" ></script>
	<script src="core\Vertex.js" ></script>
	<script src="core\Timer.js" ></script>
	<head>
	<script>
		
	var timer = new Timer(30);
	
		window.onload = function(){
		
			var canvas = document.getElementById('canvas');
			canvas.width = 800;
			canvas.height = 800;
			
		
			
			
			
			var renderer =  new Renderer(canvas);
			
			var camera = new Camera();

			camera.x = 230;
			camera.y = -230;
			camera.ry = -0.8;
			camera.z = -2000;
			
			var ctx = canvas.getContext("2d");
			
			
			var verticesrc = [ ];
			
			var polysrc =[];
			
			var uvsrc = [];
			var ll = 25;
			var pi7 = 2* Math.PI/ll;
			
			//circleVertices();
			//circlePoly();
			//circleUV();
			function circlePoly () {
			
				for( var i = 0;i<ll;i++) {
				
					polysrc[i]=[];
					polysrc[i][0]=i+1;
					polysrc[i][1]=(i+2)>ll?(i+2)-ll : i+2;
					polysrc[i][2]=ll+1;
				}
			
			}
			function circleVertices ( ) {
			
				for( var i = 0;i<ll+1;i++) {
				
					verticesrc[i]=[];
					verticesrc[i][0]=Math.cos(pi7*i)*1000;
					verticesrc[i][1]=Math.sin(pi7*i)*1000;
					verticesrc[i][2]=0;
				
					if(i===ll){
					
						verticesrc[i][0]=verticesrc[i][1]=0;
						verticesrc[i][2]=-400;
					}
				}
				
				
			}
			function circleUV (  ){
				for( var i = 0;i<ll;i++)
					{
					uvsrc[i] = [];
					uvsrc[i][0] = [];
					uvsrc[i][1] = [];
					uvsrc[i][2] = [];
					
					uvsrc[i][0][0] = 0.5+0.5*Math.cos(pi7*i);
					uvsrc[i][0][1] = 0.5-0.5*Math.sin(pi7*i);
					uvsrc[i][1][0] = 0.5+0.5*Math.cos(pi7*(i+1));
					uvsrc[i][1][1] = 0.5-0.5*Math.sin(pi7*(i+1));
					uvsrc[i][2][0] = 0.5;
					uvsrc[i][2][1] = 0.5;
					}
			
			}
			// monalisa
			var verticesrc = [[786,960,0],[79,960,0],[-530,960,0],[353,655,-229],[-15,705,-322],[-182,630,-285],[446,370,-247],[210,353,-352],[131,392,-370],[131,315,-370],[-115,379,-370],[-200,346,-352],[-36,340,-381],[-123,304,-370],[37,342,-381],[-308,290,-256],[-173,-10,-217],[-110,140,-387],[-90,66,-381],[-30,111,-421],[95,71,-375],[-38,160,-479],[80,145,-387],[786,-82,0],[309,-60,-261],[-5,-190,-289],[-41,-74,-387],[57,-74,-387],[-530,-174,0],[786,-1015,0],[-530,-1015,0],[-43,67,-419],[15,63,-419],[-43,54,-419],[15,54,-419]];
			var polysrc = [[4,2,1],[10,9,8],[10,15,9],[23,15,10],[23,22,15],[21,20,23],[33,20,21],[28,35,21],[27,35,28],[27,34,35],[27,19,34],[33,32,20],[32,19,20],[19,18,20],[27,17,19],[19,16,18],[18,16,14],[18,14,13],[14,12,11],[16,12,14],[31,29,17],[17,16,19],[30,25,24],[24,7,1],[29,3,16],[12,6,11],[14,11,13],[26,27,28],[26,17,27],[18,13,22],[22,13,15],[20,18,22],[20,22,23],[8,4,7],[8,9,4],[9,5,4],[11,6,5],[29,16,17],[26,28,25],[11,5,9],[25,23,7],[23,10,8],[23,8,7],[15,11,9],[13,11,15],[6,3,2],[6,2,5],[4,5,2],[28,21,25],[25,21,23],[31,26,30],[31,17,26],[30,26,25],[7,4,1],[24,25,7],[16,6,12],[16,3,6]];
			var uvsrc = [ [[0.6711,0.8456],[0.4627,1],[1,1]] ,
							[[0.5022,0.6733],[0.5022,0.7122],[0.5623,0.6928]],
						   [[0.5022,0.6733],[0.4309,0.6869],[0.5022,0.7122]],
						   [[0.4637,0.5875],[0.4309,0.6869],[0.5022,0.6733]],
						   [[0.4637,0.5875],[0.3745,0.595],[0.4309,0.6869]],
						   [[0.4711,0.5479],[0.3802,0.57],[0.4637,0.5875]],
						   [[0.4144,0.5479],[0.3802,0.57],[0.4711,0.5479]],
						   [[0.446,0.4766],[0.4166,0.5374],[0.4711,0.5479]],
						   [[0.3716,0.4766],[0.4166,0.5374],[0.446,0.4766]],
						   [[0.3716,0.4766],[0.3723,0.5374],[0.4166,0.5374]],
						   [[0.3716,0.4766],[0.3376,0.5484],[0.3723,0.5374]],
						  [ [0.4144,0.5479],[0.3703,0.5499],[0.3802,0.57]],
						  [ [0.3703,0.5499],[0.3376,0.5484],[0.3802,0.57]],
						   [[0.3376,0.5484],[0.3194,0.585],[0.3802,0.57]],
						   [[0.3716,0.4766],[0.2717,0.5089],[0.3376,0.5484]],
						   [[0.3376,0.5484],[0.1689,0.6608],[0.3194,0.585]],
						   [[0.3194,0.585],[0.1689,0.6608],[0.3097,0.6681]],
						   [[0.3194,0.585],[0.3097,0.6681],[0.3755,0.6862]],
						   [[0.3097,0.6681],[0.2512,0.6893],[0.3155,0.7061]],
						   [[0.1689,0.6608],[0.2512,0.6893],[0.3097,0.6681]],
						   [[0,0],[0,0.4258],[0.2717,0.5089]],
						   [[0.2717,0.5089],[0.1689,0.6608],[0.3376,0.5484]],
						   [[1,0], [0.6378,0.4835],[1,0.4726]],
						   [[1,0.4726],[0.7418,0.7013],[1,1]],
						   [[0,0.4258],[0,1],[0.1689,0.6608]],
						   [[0.2512,0.6893],[0.2648,0.8329],[0.3155,0.7061]],
						   [[0.3097,0.6681],[0.3155,0.7061],[0.3755,0.6862]],
						   [[0.3992,0.4177],[0.3716,0.4766],[0.446,0.4766]],
						   [[0.3992,0.4177],[0.2717,0.5089],[0.3716,0.4766]],
						   [[0.3194,0.585],[0.3755,0.6862],[0.3745,0.595]],
						   [[0.3745,0.595],[0.3755,0.6862],[0.4309,0.6869]],
						   [[0.3802,0.57],[0.3194,0.585],[0.3745,0.595]],
						   [[0.3802,0.57],[0.3745,0.595],[0.4637,0.5875]],
						   [[0.5623,0.6928],[0.6711,0.8456],[0.7418,0.7013]],
						   [[0.5623,0.6928],[0.5022,0.7122],[0.6711,0.8456]],
						   [[0.5022,0.7122],[0.3916,0.8709],[0.6711,0.8456]],
						   [[0.3155,0.7061],[0.2648,0.8329],[0.3916,0.8709]],
						   [[0,0.4258],[0.1689,0.6608],[0.2717,0.5089]],
						   [[0.3992,0.4177],[0.446,0.4766],[0.6378,0.4835]],
						   [[0.3155,0.7061],[0.3916,0.8709],[0.5022,0.7122]],
						   [[0.6378,0.4835],[0.4637,0.5875],[0.7418,0.7013]],
						   [[0.4637,0.5875],[0.5022,0.6733],[0.5623,0.6928]],
						   [[0.4637,0.5875],[0.5623,0.6928],[0.7418,0.7013]],
						   [[0.4309,0.6869],[0.3155,0.7061],[0.5022,0.7122]],
						   [[0.3755,0.6862],[0.3155,0.7061],[0.4309,0.6869]],
						   [[0.2648,0.8329],[0,1],[0.4627,1]],
						   [[0.2648,0.8329], [0.4627,1],[0.3916,0.8709]],
						   [[0.6711,0.8456],[0.3916,0.8709],[0.4627,1]],
						  [ [0.446,0.4766],[0.4711,0.5479],[0.6378,0.4835]],
						  [ [0.6378,0.4835],[0.4711,0.5479],[0.4637,0.5875]],
						  [ [0,0],[0.3992,0.4177],[1,0]],
						  [ [0,0],[0.2717,0.5089],[0.3992,0.4177]],
						  [ [1,0],[0.3992,0.4177],[0.6378,0.4835]],
						  [ [0.7418,0.7013],[0.6711,0.8456],[1,1]],
						  [ [1,0.4726],[0.6378,0.4835],[0.7418,0.7013]],
						  [ [0.1689,0.6608],[0.2648,0.8329],[0.2512,0.6893]],
						  [ [0.1689,0.6608],[0,1],[0.2648,0.8329]]];
			
			
			
			
			
			for(var kk = 0 ;kk<uvsrc.length;kk++){
			
				
				uvsrc[kk][0][1] = 1-uvsrc[kk][0][1];
				uvsrc[kk][1][1] = 1-uvsrc[kk][1][1];
				uvsrc[kk][2][1] = 1-uvsrc[kk][2][1];
				
			
			}
			
			
			
			
			for (var j = 0; j< verticesrc.length;j++)
				verticesrc[j][1] = -verticesrc[j][1];
			
			
			
		
			
			var targetX = 2000;
			var spring = 0.15;
			var vx=0;
			var ff = 0.85;
			var aa = function (  ) {
		
				var dx= targetX - camera.x;
				
				var ax=dx*spring;
				vx+=ax;
				vx*=ff;
				camera.x +=vx;
				
				renderer.render(faces , camera);
				
			}
			
			
			timer.addAction(aa);
			
			
			var tex = new Image();
			tex.src = "monalisa.jpg";
			//	tex.src = "sharaku.jpg";
		
		
			tex.onload = function() {   
					
					createVertex(verticesrc);
					
					createFaces(polysrc);
					
					timer.start();
				}
				
		
		var vertices = [];
		var faces = [];///!!!!!!!!!!!!!!!!!!!! 每一个mesh对应一个大图片，而不是一个face数组对应一个大图片，这里是测试		
				
		function createVertex ( src ) {
		
			var len = src.length;
			
			for ( var i = 0 ; i < len ; i++ ) {
			
				var v = src[i];
				vertices.push( new  Vertex(v[0],v[1],v[2]) );
			
			}
		
		}
		
		function createFaces ( src ) {
		
			var len = src.length;
			
			for ( var i = 0 ; i < len ; i++ ) {
			
				var f = src[i];
				
							
				var face = new Face(vertices[f[0]-1],vertices[f[1]-1],vertices[f[2]-1]);
				
				//if(i==1)
				face.setMaterial( tex ,uvsrc[i] );
				
				faces.push( face );
			
			}
		
		}
		
			
			
		}
		
		/* 需要封装的内容：  读取mesh信息，一个mesh对应一个img标签，一个mesh对应一组原始顶点信息、原始面信息、原始贴图映射信息。以后还会有bonesrc、animation等信息
						     形如：
							 
							 mesh1 = {
								id : "img1",
								verticesrc : [],
								facesrc : [],
								uvs : [],
								bonesrc : [],
								animation : [] //animation先实现预设动画
							 }
							 
							 根据mesh信息，生成3d模型及动画
		
			 
		
		*/
	
		
		
	
			
			
	
	
	
	</script>
	</head>
	<body>
	
	<input type="button" value="stop" onclick = "timer.stop();"></input>
	<input type="button" value="start" onclick = "timer.start();"></input>
		
	<canvas id="canvas" style="border:1px solid black">
	
	</canvas>
	
	
	<canvas id="ccc">
	
	
	</canvas>
	
	</body>

	

</html>